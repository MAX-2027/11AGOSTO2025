<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mapa MANZANAS_1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 90vh; }
        #comments {
            height: 10vh;
            overflow-y: auto;
            border-top: 1px solid #ccc;
            padding: 5px;
        }
        .comment { border-bottom: 1px solid #eee; padding: 2px; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="comments">
    <strong>Comentarios:</strong>
    <div id="commentList"></div>
    <input type="text" id="commentInput" placeholder="Escribe un comentario..." style="width:80%">
    <button id="sendComment">Enviar</button>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Archivo GeoJSON -->
<script src="MANZANAS_1.js"></script>

<script>
    // Configura tu conexión a Supabase
    const SUPABASE_URL = "https://ayehvsjxzzwgkdubpcnq.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5ZWh2c2p4enp3Z2tkdWJwY25xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjIwOTIsImV4cCI6MjA3MDY5ODA5Mn0.PcZ-paE_i8SycjhA7s1MrQePBYyEg1U8pVBg8wFkb1U";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let selectedPolygonId = null;

    // Crear mapa
    const map = L.map('map').setView([-2.886, -78.962], 15);

    // Capa base
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Función para mostrar comentarios
    async function loadComments(poligonoId) {
        const { data, error } = await supabaseClient
            .from('comentarios')
            .select('*')
            .eq('poligono_id', poligonoId)
            .order('created_at', { ascending: false });
        
        const commentList = document.getElementById('commentList');
        commentList.innerHTML = "";
        if (error) {
            commentList.innerHTML = "<em>Error cargando comentarios</em>";
            return;
        }
        data.forEach(c => {
            const div = document.createElement('div');
            div.classList.add('comment');
            div.textContent = c.texto;
            commentList.appendChild(div);
        });
    }

    // Enviar comentario
    document.getElementById('sendComment').addEventListener('click', async () => {
        const text = document.getElementById('commentInput').value.trim();
        if (!text || !selectedPolygonId) return;

        const { error } = await supabaseClient
            .from('comentarios')
            .insert([{ poligono_id: selectedPolygonId, texto: text }]);
        
        if (!error) {
            document.getElementById('commentInput').value = "";
            loadComments(selectedPolygonId);
        }
    });

    // Dibujar polígonos
    L.geoJSON(json_MANZANAS_1, {
        onEachFeature: function (feature, layer) {
            const polyId = feature.properties[""];
            layer.on('click', function () {
                selectedPolygonId = polyId;
                loadComments(polyId);
            });
            layer.bindPopup("Polígono ID: " + polyId);
        },
        style: { color: 'blue', weight: 2 }
    }).addTo(map);
</script>

</body>
</html>
