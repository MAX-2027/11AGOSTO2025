<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link rel="stylesheet" href="css/leaflet.photon.css">
    <title>MAPA DE PRECIOS + Comentarios (Supabase)</title>
    <style>
      html, body, #map { width: 100%; height: 100%; padding: 0; margin: 0; }
      /* Caja de comentarios */
      .comments-wrap { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; }
      .comments-title { font-weight: 700; margin: 6px 0; }
      .comments-list { max-height: 180px; overflow: auto; padding: 8px; background: #f7f7f7; border-radius: 8px; border: 1px solid #e5e5e5; }
      .comment-item { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #ddd; }
      .comment-meta { font-size: 12px; opacity: 0.8; }
      .comment-body { margin: 4px 0; white-space: pre-wrap; }
      .comment-form { margin-top: 8px; display: grid; gap: 6px; }
      .comment-form input, .comment-form textarea { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #d1d5db; }
      .comment-form button { padding: 8px 10px; border: 0; border-radius: 8px; background: #2563eb; color: white; font-weight: 600; cursor: pointer; }
      .comment-form button[disabled] { opacity: 0.6; cursor: not-allowed; }
      .comment-help { font-size: 12px; color: #6b7280; }
      .leaflet-popup-content { min-width: 300px; }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <!-- LIBRER√çAS EXISTENTES -->
    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js"></script>
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/leaflet.pattern.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/labels.js"></script>
    <script src="js/leaflet.photon.js"></script>

    <!-- SUS DATOS GEOJSON -->
    <script src="data/MANZANAS_1.js"></script>

    <!-- Supabase JS v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      // ‚öôÔ∏è 1) CONFIGURAR SUS CREDENCIALES DE SUPABASE
      // üëâ Reemplace los valores por los suyos (Proyecto > Configuraci√≥n > API)
      const SUPABASE_URL = "https://ayehvsjxzzwgkdubpcnq.supabase.co";  // ‚¨ÖÔ∏è CAMBIAR
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5ZWh2c2p4enp3Z2tkdWJwY25xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjIwOTIsImV4cCI6MjA3MDY5ODA5Mn0.PcZ-paE_i8SycjhA7s1MrQePBYyEg1U8pVBg8wFkb1U";                     // ‚¨ÖÔ∏è CAMBIAR

      // Inicializar cliente
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Utilidad: formatear fecha local
      function fmtDate(iso) {
        try {
          const d = new Date(iso);
          return d.toLocaleString();
        } catch (e) {
          return iso;
        }
      }

      // --- C√≥digo original base (mapa y estilos) ---
      var map = L.map('map', { zoomControl:false, maxZoom:28, minZoom:1 })
        .fitBounds([[-2.8993770787955575,-79.00050086369173],[-2.8390137111079725,-78.87304867311882]]);

      var hash = new L.Hash(map);
      map.attributionControl.setPrefix('');
      var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

      var title = new L.Control({'position':'topleft'});
      title.onAdd = function (map) { this._div = L.DomUtil.create('div', 'info'); this.update(); return this._div; };
      title.update = function () { this._div.innerHTML = '<h2>MAPA DE PRECIOS</h2>'; };
      title.addTo(map);

      var abstract = new L.Control({'position':'bottomright'});
      abstract.onAdd = function (map) { this._div = L.DomUtil.create('div', 'leaflet-control abstract'); this._div.id = 'abstract'; abstract.show(); return this._div; };
      abstract.show = function () { this._div.classList.remove('abstract'); this._div.classList.add('abstractUncollapsed'); this._div.innerHTML = '2025'; };
      abstract.addTo(map);

      var zoomControl = L.control.zoom({ position: 'topleft' }).addTo(map);
      var bounds_group = new L.featureGroup([]);
      function setBounds() {}

      map.createPane('pane_GoogleSatellite_0');
      map.getPane('pane_GoogleSatellite_0').style.zIndex = 400;
      var layer_GoogleSatellite_0 = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        pane: 'pane_GoogleSatellite_0',
        opacity: 1.0,
        attribution: '',
        minZoom: 1, maxZoom: 28, minNativeZoom: 0, maxNativeZoom: 22
      });
      map.addLayer(layer_GoogleSatellite_0);

      // --- Comentarios por pol√≠gono (UI + l√≥gica) ---
      function polygonIdFromFeature(feature) {
        // Preferimos la propiedad NUMERO; si no existe, usamos un fallback estable.
        return (feature && feature.properties && (feature.properties['NUMERO'] ?? feature.properties['id'] ?? feature.properties['ID'])) ?? String(Math.random()).slice(2);
      }

      // Renderizar lista de comentarios
      function renderComments(listEl, rows) {
        listEl.innerHTML = '';
        if (!rows || rows.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'comment-item';
          empty.textContent = 'S√© el primero en comentar üó®Ô∏è';
          listEl.appendChild(empty);
          return;
        }
        rows.forEach(row => {
          const item = document.createElement('div');
          item.className = 'comment-item';
          const who = document.createElement('div');
          who.className = 'comment-meta';
          who.textContent = (row.author || 'An√≥nimo') + ' ‚Ä¢ ' + fmtDate(row.created_at);
          const body = document.createElement('div');
          body.className = 'comment-body';
          body.textContent = row.body;
          item.appendChild(who);
          item.appendChild(body);
          listEl.appendChild(item);
        });
        listEl.scrollTop = listEl.scrollHeight;
      }

      async function loadComments(polygonId, listEl) {
        const { data, error } = await supabase
          .from('comments')
          .select('*')
          .eq('polygon_id', String(polygonId))
          .order('created_at', { ascending: true });
        if (error) {
          console.error('Error cargando comentarios', error);
          listEl.innerHTML = '<div class="comment-item">No se pudieron cargar los comentarios.</div>';
          return;
        }
        renderComments(listEl, data);
      }

      function subscribeComments(polygonId, listEl) {
        const channel = supabase.channel('comments_poly_' + polygonId)
          .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'comments',
            filter: 'polygon_id=eq.' + String(polygonId)
          }, payload => {
            // A√±adir nuevo comentario al final
            const row = payload.new;
            const curr = listEl.querySelectorAll('.comment-item').length ? null : []; // si estaba vac√≠o, recargar todo
            if (curr === null) {
              // insertar incremental
              const item = document.createElement('div');
              item.className = 'comment-item';
              const who = document.createElement('div');
              who.className = 'comment-meta';
              who.textContent = (row.author || 'An√≥nimo') + ' ‚Ä¢ ' + fmtDate(row.created_at);
              const body = document.createElement('div');
              body.className = 'comment-body';
              body.textContent = row.body;
              item.appendChild(who);
              item.appendChild(body);
              listEl.appendChild(item);
              listEl.scrollTop = listEl.scrollHeight;
            } else {
              loadComments(polygonId, listEl);
            }
          })
          .subscribe((status) => {
            if (status === 'SUBSCRIBED') {
              // Nada
            }
          });
        return channel;
      }

      async function handleSubmit(ev, polygonId, listEl, btnEl) {
        ev.preventDefault();
        const form = ev.target;
        const author = form.querySelector('input[name="author"]').value.trim() || 'An√≥nimo';
        const body = form.querySelector('textarea[name="body"]').value.trim();
        if (!body) return;
        btnEl.disabled = true;
        try {
          const { error } = await supabase.from('comments').insert({
            polygon_id: String(polygonId),
            author,
            body
          });
          if (error) throw error;
          form.reset();
        } catch (e) {
          alert('No se pudo guardar el comentario. Revise su conexi√≥n e intente de nuevo.');
          console.error(e);
        } finally {
          btnEl.disabled = false;
        }
      }

      function pop_MANZANAS_1(feature, layer) {
        const polygonId = polygonIdFromFeature(feature);

        // Tabla original + UI de comentarios
        const baseHtml = `
          <div class="comments-wrap">
            <div id="attrs-${polygonId}"></div>
            <hr/>
            <div class="comments-title">Comentarios para pol√≠gono: <strong>${polygonId}</strong></div>
            <div id="list-${polygonId}" class="comments-list" aria-live="polite"></div>
            <form id="form-${polygonId}" class="comment-form">
              <input type="text" name="author" maxlength="80" placeholder="Tu nombre (opcional)"/>
              <textarea name="body" rows="3" maxlength="1000" placeholder="Escribe tu comentario..." required></textarea>
              <button type="submit" id="btn-${polygonId}">Publicar</button>
              <div class="comment-help">Al publicar aceptas que tu comentario sea p√∫blico. No compartas datos sensibles.</div>
            </form>
          </div>
        `;

        // Atributos del pol√≠gono (breve)
        const attrsHtml = `
          <table>
            <tr><td colspan="2">${feature.properties['ESTRATOS'] ?? ''}</td></tr>
            <tr><td colspan="2">${feature.properties['PRECIOXM2'] ?? ''}</td></tr>
            <tr><td colspan="2">${feature.properties['NUMERO'] ?? ''}</td></tr>
          </table>
        `;

        layer.bindPopup(baseHtml, { maxHeight: 500 });

        layer.on('popupopen', async (e) => {
          const popupEl = e.popup.getElement();
          // Inyectar tabla de atributos
          const attrsEl = popupEl.querySelector('#attrs-' + polygonId);
          if (attrsEl) attrsEl.innerHTML = attrsHtml;

          const listEl = popupEl.querySelector('#list-' + polygonId);
          const formEl = popupEl.querySelector('#form-' + polygonId);
          const btnEl  = popupEl.querySelector('#btn-' + polygonId);

          // Cargar comentarios existentes
          await loadComments(polygonId, listEl);
          // Suscribirse a nuevos comentarios (realtime)
          layer._commentChannel = subscribeComments(polygonId, listEl);

          // Manejar env√≠o
          formEl.addEventListener('submit', (ev) => handleSubmit(ev, polygonId, listEl, btnEl), { once: false });
        });

        layer.on('popupclose', () => {
          // Limpia la suscripci√≥n para evitar fugas de memoria
          if (layer._commentChannel) {
            supabase.removeChannel(layer._commentChannel);
            layer._commentChannel = null;
          }
        });
      }

      function style_MANZANAS_1_0() {
        return {
          pane: 'pane_MANZANAS_1',
          opacity: 1,
          color: 'rgba(35,35,35,0.562)',
          dashArray: '',
          lineCap: 'butt',
          lineJoin: 'miter',
          weight: 1.0,
          fill: true,
          fillOpacity: 1,
          fillColor: 'rgba(213,4,4,0.562)',
          interactive: true,
        }
      }

      map.createPane('pane_MANZANAS_1');
      map.getPane('pane_MANZANAS_1').style.zIndex = 401;
      map.getPane('pane_MANZANAS_1').style['mix-blend-mode'] = 'normal';

      var layer_MANZANAS_1 = new L.geoJson(json_MANZANAS_1, {
        attribution: '',
        interactive: true,
        dataVar: 'json_MANZANAS_1',
        layerName: 'layer_MANZANAS_1',
        pane: 'pane_MANZANAS_1',
        onEachFeature: pop_MANZANAS_1,
        style: style_MANZANAS_1_0,
      });
      bounds_group.addLayer(layer_MANZANAS_1);
      map.addLayer(layer_MANZANAS_1);
      setBounds();

      // Br√∫jula (igual al original)
      var compassControl = L.Control.extend({
        options: { position: 'topright' },
        onAdd: function (map) {
          var container = L.DomUtil.create('div', 'leaflet-control-compass');
          container.innerHTML = '<img src="img/compass-watercolor.png" alt="Br√∫jula" style="width:80px; height:auto; opacity:0.85;">';
          return container;
        }
      });
      map.addControl(new compassControl());
      var style = document.createElement('style');
      style.innerHTML = '.leaflet-control-compass{background:transparent;border:none;box-shadow:none;pointer-events:none;}';
      document.head.appendChild(style);
    </script>
  </body>
</html>